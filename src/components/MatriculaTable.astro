---
interface Props {
    matriculas: any[];
}

const { matriculas } = Astro.props;
---

<section class="bg-white border-2 border-brand-light rounded-[2.5rem] shadow-sm overflow-hidden">
    <div class="p-6 border-b-2 border-brand-light flex flex-col md:flex-row gap-6 justify-between items-end bg-brand-light/10">
        <div class="flex items-center gap-3">
            <label class="text-[10px] uppercase font-black tracking-widest text-brand">Mostrar</label>
            <select
                id="mat-page-size"
                class="bg-white border-2 border-brand-light rounded-xl px-4 py-2 text-sm font-bold text-brand-deep outline-none focus:border-brand transition-all cursor-pointer"
            >
                <option value="10">10</option>
                <option value="50">50</option>
                <option value="all">Todo</option>
            </select>
        </div>

        <div class="relative w-full md:w-64">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 opacity-40">ğŸ”</span>
            <input
                type="text"
                id="mat-search-input"
                placeholder="Buscar vehÃ­culo o cliente..."
                class="w-full pl-11 pr-4 py-3 bg-white border-2 border-brand-light rounded-2xl text-sm text-brand-deep outline-none focus:border-brand transition-all font-bold placeholder:opacity-30"
            />
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-brand-light/20 border-b-2 border-brand-light">
                    <th class="p-6 text-[10px] font-black text-brand uppercase tracking-widest">MatrÃ­cula</th>
                    <th class="p-6 text-[10px] font-black text-brand uppercase tracking-widest">Cliente Asignado</th>
                    <th class="p-6 text-[10px] font-black text-brand uppercase tracking-widest text-right">Acciones</th>
                </tr>
            </thead>
            <tbody
                id="mat-table-body"
                data-matriculas={JSON.stringify(matriculas)}
                class="divide-y divide-brand-light/30"
            >
                </tbody>
        </table>
    </div>

    <div id="no-results" class="hidden p-20 text-center bg-gray-50/50">
        <p class="text-brand-dark/30 font-bold italic uppercase text-xs tracking-widest">No se han encontrado resultados</p>
    </div>
</section>

<script>
    function initMatTable() {
        const body = document.getElementById('mat-table-body');
        const search = document.getElementById('mat-search-input') as HTMLInputElement;
        const size = document.getElementById('mat-page-size') as HTMLSelectElement;
        const emptyState = document.getElementById('no-results');

        if (!body || !search || !size) return;

        const rawData = body.getAttribute('data-matriculas');
        let matriculas = [];
        try {
            matriculas = rawData ? JSON.parse(rawData) : [];
        } catch (e) {
            console.error("Error parseando matrÃ­culas", e);
        }

        const render = () => {
            const term = search.value.toLowerCase();
            const limit = size.value === 'all' ? matriculas.length : parseInt(size.value);

            const filtered = matriculas.filter((m: any) => 
                m.numero.toLowerCase().includes(term) || 
                m.clienteNombre.toLowerCase().includes(term)
            );

            if (filtered.length === 0) {
                emptyState?.classList.remove('hidden');
                body.innerHTML = '';
                return;
            }

            emptyState?.classList.add('hidden');
            body.innerHTML = filtered.slice(0, limit).map((m: any) => `
                <tr class="group transition-all duration-200 hover:bg-brand/[0.03] cursor-default border-b border-brand-light/30 last:border-0">
                    <td class="p-6">
                        <span class="bg-brand-light/50 px-3 py-1.5 rounded-xl font-black text-brand-deep uppercase text-sm border border-brand/10 group-hover:border-brand/30 group-hover:bg-brand-light/80 transition-all">
                            ${m.numero}
                        </span>
                    </td>
                    <td class="p-6">
                        <button 
                            class="info-btn text-brand-deep font-bold hover:text-brand transition-all relative group/link text-sm uppercase tracking-tight"
                            data-client-id="${m.clienteId}"
                            data-client-nombre="${m.clienteNombre}"
                        >
                            ${m.clienteNombre}
                            <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-brand transition-all group-hover/link:w-full"></span>
                        </button>
                    </td>
                    <td class="p-6 text-right">
                        <div class="flex justify-end gap-2 md:opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <button 
                                class="edit-btn w-10 h-10 rounded-xl bg-brand/10 text-brand flex items-center justify-center hover:bg-brand hover:text-white transition-all shadow-sm"
                                data-m='${JSON.stringify(m)}'
                            >âœï¸</button>
                            <button 
                                class="delete-btn w-10 h-10 rounded-xl bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all shadow-sm"
                                data-id="${m.id}"
                                data-numero="${m.numero}"
                            >ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Asignar eventos despuÃ©s de renderizar
            body.querySelectorAll('.info-btn').forEach(btn => {
                (btn as HTMLElement).onclick = () => {
                    const d = (btn as HTMLElement).dataset;
                    window.dispatchEvent(new CustomEvent('open-info-modal', { detail: { id: d.clientId, nombre: d.clientNombre } }));
                };
            });

            body.querySelectorAll('.edit-btn').forEach(btn => {
                (btn as HTMLElement).onclick = () => {
                    const data = JSON.parse((btn as HTMLElement).dataset.m || '{}');
                    window.dispatchEvent(new CustomEvent('open-edit-mat-modal', { detail: data }));
                };
            });

            body.querySelectorAll('.delete-btn').forEach(btn => {
                (btn as HTMLElement).onclick = () => {
                    const d = (btn as HTMLElement).dataset;
                    window.dispatchEvent(new CustomEvent('open-delete-mat-modal', { detail: { id: d.id, numero: d.numero } }));
                };
            });
        };

        search.addEventListener('input', render);
        size.addEventListener('change', render);
        render(); // Render inicial
    }

    // Ejecutar en carga inicial y en navegaciones de Astro
    document.addEventListener('astro:page-load', initMatTable);
</script>
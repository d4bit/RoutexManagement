---
interface Props {
    initialClients: any[];
}

const { initialClients } = Astro.props;
---

<section class="bg-white border-2 border-brand rounded-3xl shadow-md shadow-brand/5 overflow-hidden">

    <!-- Controles -->
    <div class="p-6 border-b border-brand/10 flex flex-col md:flex-row gap-6 justify-between items-end">

        <!-- TamaÃ±o de pÃ¡gina -->
        <div class="flex items-center gap-3">
            <label class="text-[11px] uppercase font-black tracking-widest text-brand">
                Mostrar
            </label>
            <select
                id="page-size"
                class="bg-brand/5 border-2 border-brand/10 rounded-xl px-4 py-2
                       text-sm font-bold text-brand-deep
                       outline-none focus:border-brand focus:bg-white transition-all"
            >
                <option value="10">10</option>
                <option value="50">50</option>
                <option value="all">Todo</option>
            </select>
        </div>

        <!-- Buscador -->
        <div class="relative w-full md:w-64">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-brand/40">
                ğŸ”
            </span>
            <input
                type="text"
                id="search-input"
                placeholder="Buscar clienteâ€¦"
                class="w-full pl-11 pr-4 py-3 bg-brand/5 border-2 border-brand/10
                       rounded-2xl text-sm text-brand-deep
                       outline-none focus:border-brand focus:bg-white transition-all"
            />
        </div>
    </div>

    <!-- Tabla -->
    <div class="overflow-x-auto">
        <table class="w-full border-collapse">
            <thead>
                <tr class="bg-brand/5 text-[11px] uppercase tracking-widest text-brand font-black">
                    <th class="px-6 py-4 text-left">Cliente</th>
                    <th class="px-6 py-4 text-left">Observaciones</th>
                    <th class="px-6 py-4 text-right">Acciones</th>
                </tr>
            </thead>

            <tbody
                id="table-body"
                data-clients={JSON.stringify(initialClients)}
                class="divide-y divide-brand/10"
            ></tbody>
        </table>
    </div>
</section>

<script>
    const setupTable = () => {
        const body = document.getElementById('table-body');
        const search = document.getElementById('search-input');
        const size = document.getElementById('page-size');

        if (!body || !search || !size) return;

        const rawData = body.getAttribute('data-clients');
        const clients = rawData ? JSON.parse(rawData) : [];

        const render = () => {
            const term = search.value.toLowerCase();
            const limit = size.value === 'all'
                ? clients.length
                : parseInt(size.value);

            const filtered = clients.filter(c =>
                c.nombre.toLowerCase().includes(term)
            );

            body.innerHTML = filtered.slice(0, limit).map(c => `
                <tr class="hover:bg-brand/5 transition-colors group">
                    <td class="px-6 py-4 font-bold">
                        <button
                            class="text-brand hover:text-brand-deep hover:underline transition-all text-left"
                            data-client='${JSON.stringify(c)}'
                        >
                            ${c.nombre}
                        </button>
                    </td>

                    <td class="px-6 py-4 text-sm text-brand-dark/70 italic">
                        ${c.observaciones || 'â€”'}
                    </td>

                    <td class="px-6 py-4 flex justify-end gap-2">
                        <button
                            class="edit-btn p-2 rounded-xl border-2 border-brand/20 bg-white
                                   text-brand hover:bg-brand/10 transition-all"
                            data-client='${JSON.stringify(c)}'
                        >
                            âœï¸
                        </button>

                        <button
                            class="del-btn p-2 rounded-xl border-2 border-red-200 bg-white
                                   text-red-500 hover:bg-red-50 transition-all"
                            data-id="${c.id}"
                            data-nombre="${c.nombre}"
                        >
                            ğŸ—‘ï¸
                        </button>
                    </td>
                </tr>
            `).join('');

            body.querySelectorAll('[data-client]').forEach(btn => {
                btn.onclick = () => {
                    const client = JSON.parse(btn.dataset.client);

                    if (btn.classList.contains('edit-btn')) {
                        window.dispatchEvent(
                            new CustomEvent('open-edit-modal', { detail: client })
                        );
                    } else {
                        window.dispatchEvent(
                            new CustomEvent('open-info-modal', { detail: client })
                        );
                    }
                };
            });

            body.querySelectorAll('.del-btn').forEach(btn => {
                btn.onclick = () => {
                    const { id, nombre } = btn.dataset;

                    window.dispatchEvent(
                        new CustomEvent('open-delete-modal', {
                            detail: { id, nombre }
                        })
                    );
                };
            });
        };

        search.oninput = render;
        size.onchange = render;
        render();
    };

    document.addEventListener('astro:page-load', setupTable);
</script>

---
interface Column {
    key: string;      
    label: string;    
    type?: 'badge' | 'text' | 'action' | 'currency';
    align?: 'left' | 'right' | 'center';
}

interface Props {
    id: string;             
    columns: Column[];
    data: any[];
    searchPlaceholder?: string;
    defaultPageSize?: number;
}

const { id, columns, data, searchPlaceholder = "Buscar registros...", defaultPageSize = 50 } = Astro.props;
---

<section class="bg-white border border-slate-200 rounded-[2.5rem] shadow-sm overflow-hidden mb-10 group/table transition-all">
    <div class="p-6 border-b border-slate-100 flex flex-col lg:flex-row gap-6 justify-between items-center bg-slate-50/50">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-green-600 animate-pulse"></div>
                <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">Registros del sistema</h3>
            </div>
            <div class="flex items-center gap-2 bg-white border border-slate-200 rounded-2xl px-4 py-1.5">
                <label class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">Ver:</label>
                <select id={`pagesize-${id}`} class="text-[10px] font-black text-green-700 outline-none bg-transparent cursor-pointer">
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                </select>
            </div>
        </div>
        
        <div class="relative w-full md:w-96 group/search">
            <input 
                type="text" 
                id={`search-${id}`} 
                placeholder={searchPlaceholder} 
                class="w-full pl-12 pr-6 py-3.5 bg-white border border-slate-200 rounded-2xl text-sm font-bold text-slate-600 outline-none focus:border-green-600/40 focus:ring-4 focus:ring-green-600/5 transition-all shadow-sm" 
            />
            <span class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within/search:text-green-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            </span>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full border-separate border-spacing-0">
            <thead>
                <tr class="text-[10px] uppercase tracking-widest text-slate-400 font-black bg-slate-50/20">
                    {columns.map((col) => (
                        <th 
                            class={`px-8 py-5 border-b border-slate-100 transition-colors hover:bg-slate-50 cursor-pointer group/th ${col.align === 'right' ? 'text-right' : 'text-left'}`} 
                            data-sort={col.key}
                        >
                            <div class={`flex items-center gap-2 ${col.align === 'right' ? 'justify-end' : ''}`}>
                                {col.label}
                                {col.type !== 'action' && (
                                    <span class="text-green-600 opacity-0 group-hover/th:opacity-100 transition-all">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>
                                    </span>
                                )}
                            </div>
                        </th>
                    ))}
                </tr>
            </thead>
            <tbody 
                id={`body-${id}`} 
                data-json={JSON.stringify(data)} 
                data-cols={JSON.stringify(columns)} 
                class="divide-y divide-slate-50"
            >
                </tbody>
        </table>
    </div>

    <div class="p-6 bg-slate-50/50 border-t border-slate-100 flex flex-col sm:flex-row items-center justify-between px-8 gap-4">
        <span id={`info-${id}`} class="text-[10px] font-black text-slate-500 uppercase tracking-widest">
            Cargando registros...
        </span>
        <div class="flex gap-3">
            <button id={`prev-${id}`} class="flex items-center gap-2 px-5 py-2.5 bg-white border border-slate-200 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:border-green-600 hover:text-green-700 disabled:opacity-30 disabled:hover:border-slate-200 disabled:hover:text-slate-400 transition-all shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                Anterior
            </button>
            <button id={`next-${id}`} class="flex items-center gap-2 px-5 py-2.5 bg-white border border-slate-200 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:border-green-600 hover:text-green-700 disabled:opacity-30 disabled:hover:border-slate-200 disabled:hover:text-slate-400 transition-all shadow-sm">
                Siguiente
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
            </button>
        </div>
    </div>
</section>

<script define:vars={{ tableId: id, defaultPageSize }}>
    function initTable() {
        const body = document.getElementById(`body-${tableId}`);
        const search = document.getElementById(`search-${tableId}`);
        const selectSize = document.getElementById(`pagesize-${tableId}`);
        const btnPrev = document.getElementById(`prev-${tableId}`);
        const btnNext = document.getElementById(`next-${tableId}`);
        const info = document.getElementById(`info-${tableId}`);
        const headers = document.querySelectorAll(`[data-sort]`);
        
        if (!body) return;

        let allData = JSON.parse(body.dataset.json || '[]');
        const cols = JSON.parse(body.dataset.cols || '[]');
        
        let currentPage = 1;
        let pageSize = parseInt(selectSize.value) || defaultPageSize;
        let sortKey = 'id';
        let sortOrder = 'desc';
        let currentFilteredData = [...allData];

        const render = () => {
            const term = search.value.toLowerCase();
            let displayData = currentFilteredData.filter(item => 
                Object.values(item).some(val => String(val || '').toLowerCase().includes(term))
            );

            displayData.sort((a, b) => {
                let valA = a[sortKey] ?? '';
                let valB = b[sortKey] ?? '';
                let comp = !isNaN(valA) && !isNaN(valB) && valA !== '' 
                    ? Number(valA) - Number(valB) 
                    : String(valA).localeCompare(String(valB), 'es', { numeric: true });
                return sortOrder === 'asc' ? comp : -comp;
            });

            const totalPages = Math.ceil(displayData.length / pageSize) || 1;
            const start = (currentPage - 1) * pageSize;
            const pageItems = displayData.slice(start, start + pageSize);

            info.innerHTML = `Viendo <span class="text-green-700 font-black">${displayData.length > 0 ? start + 1 : 0}-${Math.min(start + pageSize, displayData.length)}</span> de <span class="text-green-700 font-black">${displayData.length}</span>`;
            btnPrev.disabled = currentPage === 1;
            btnNext.disabled = currentPage === totalPages;

            body.innerHTML = pageItems.map(item => {
                const rowHtml = cols.map((col, idx) => {
                    let val = item[col.key];
                    if (col.key === 'fecha' && val) val = new Date(val).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                    
                    let content = `<span class="${col.key === 'comentarios' ? 'text-slate-400 italic font-medium' : 'text-slate-600'}">${val ?? '—'}</span>`;
                    
                    if (col.type === 'currency') {
                        content = `<span class="text-green-800 font-black">${new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(Number(val || 0))}</span>`;
                    }
                    if (col.key === 'cantidad') {
                        content = `<span class="text-slate-800">${Number(val || 0).toLocaleString('es-ES', { minimumFractionDigits: 2 })}</span> <span class="text-[9px] text-green-600 font-black uppercase ml-0.5">L</span>`;
                    }
                    if (col.type === 'badge') {
                        content = `<span class="bg-green-100/50 text-green-800 px-3 py-1.5 rounded-xl font-black uppercase text-[10px] border border-green-200/50">${val}</span>`;
                    }
                    
                    if (col.type === 'action') {
                        content = `
                            <div class="flex justify-end gap-2">
                                <button data-action="edit" data-id="${item.id}" class="w-9 h-9 flex items-center justify-center rounded-xl border border-slate-200 bg-white hover:border-green-600 hover:text-green-700 transition-all shadow-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                </button>
                                <button data-action="delete" data-id="${item.id}" class="w-9 h-9 flex items-center justify-center rounded-xl border border-slate-200 bg-white hover:border-red-600 hover:text-red-700 transition-all shadow-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                </button>
                            </div>
                        `;
                    }

                    return `
                        <td class="px-8 py-4 ${col.align === 'right' ? 'text-right' : 'text-left'} text-sm relative">
                            ${idx === 0 ? `<div class="absolute left-0 top-3 bottom-3 w-1 bg-green-600 rounded-r-full scale-y-0 group-hover/tr:scale-y-100 transition-transform duration-300"></div>` : ''}
                            ${content}
                        </td>
                    `;
                }).join('');

                return `<tr class="hover:bg-slate-50 transition-colors group/tr">${rowHtml}</tr>`;
            }).join('');
        };

        // Delegación de eventos
        body.onclick = (e) => {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            const action = btn.dataset.action;
            const id = btn.dataset.id;
            const record = allData.find(item => String(item.id) === id);
            window.dispatchEvent(new CustomEvent(`${action}-record-${tableId}`, { detail: record }));
        };

        search.oninput = () => { currentPage = 1; render(); };
        selectSize.onchange = () => { pageSize = parseInt(selectSize.value); currentPage = 1; render(); };
        btnPrev.onclick = () => { if (currentPage > 1) { currentPage--; render(); } };
        btnNext.onclick = () => { if (currentPage < Math.ceil(currentFilteredData.length / pageSize)) { currentPage++; render(); } };
        
        headers.forEach(h => h.onclick = () => { 
            const k = h.dataset.sort; 
            if (!k) return;
            sortOrder = (sortKey === k) ? (sortOrder === 'asc' ? 'desc' : 'asc') : 'asc'; 
            sortKey = k; 
            render(); 
        });

        render();
    }

    document.addEventListener('astro:page-load', initTable);
    initTable();
</script>
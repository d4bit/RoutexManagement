---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import ClientForm from '../components/ClientForm.astro';
import ClientTable from '../components/ClientTable.astro';
import ClientEditModal from '../components/ClientEditModal.astro';
import ClientDetailsModal from '../components/ClientDetailsModal.astro';
import ClientDeleteModal from '../components/ClientDeleteModal.astro';
import { db, Cliente, desc } from 'astro:db';

const clientes = await db.select().from(Cliente).orderBy(desc(Cliente.id));
---

<DashboardLayout title="GestiÃ³n de Clientes">
    <div class="space-y-6">
        <ClientForm />
        <ClientTable initialClients={clientes} />
    </div>

    <ClientEditModal />
    <ClientDetailsModal />
    <ClientDeleteModal />
</DashboardLayout>

<style is:global>
    .modal-fixed {
        position: fixed;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        margin: 0;
    }

    dialog::backdrop {
        background: rgba(10, 25, 47, 0.6);
        backdrop-filter: blur(4px);
    }
</style>

<script>
    import { actions } from 'astro:actions';
    
    function initModals() {
        const editModal = document.getElementById('edit-modal') as HTMLDialogElement;
        const infoModal = document.getElementById('info-modal') as HTMLDialogElement;
        const deleteModal = document.getElementById('delete-modal') as HTMLDialogElement;
        const editForm = document.getElementById('edit-form') as HTMLFormElement;
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        let clientIdToDelete: number | null = null;

        window.addEventListener('open-edit-modal', (e: any) => {
            (document.getElementById('m-id') as HTMLInputElement).value = e.detail.id;
            (document.getElementById('m-nombre') as HTMLInputElement).value = e.detail.nombre;
            (document.getElementById('m-obs') as HTMLTextAreaElement).value = e.detail.observaciones || '';
            editModal.showModal();
        });

        window.addEventListener('open-info-modal', (e: any) => {
            const title = document.getElementById('info-title');
            if (title) title.innerText = e.detail.nombre;
            infoModal.showModal();
        });

        window.addEventListener('open-delete-modal', (e: any) => {
            clientIdToDelete = Number(e.detail.id);
            const nameSpan = document.getElementById('delete-client-name');
            if (nameSpan) nameSpan.innerText = e.detail.nombre;
            deleteModal.showModal();
        });

        confirmDeleteBtn?.addEventListener('click', async () => {
            if (clientIdToDelete) {
                const { error } = await actions.deleteClient({ id: clientIdToDelete });
                if (!error) window.location.reload();
            }
        });

        editForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { error } = await actions.upsertClient(new FormData(editForm));
            if (!error) window.location.reload();
        });

        [editModal, infoModal, deleteModal].forEach(m => {
            m?.addEventListener('click', (e) => {
                if (e.target === m) m.close();
            });
        });
    }

    document.addEventListener('astro:page-load', initModals);
</script>
---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import DynamicForm from '../components/DynamicForm.astro';
import DynamicTable from '../components/DynamicTable.astro';
import DynamicModal from '../components/DynamicModal.astro';
import { db, Matricula, Cliente, eq, desc } from 'astro:db';

// 1. Datos con JOIN para ver el nombre del cliente en la tabla
const matriculasConCliente = await db
    .select({
        id: Matricula.id,
        numero: Matricula.numero,
        clienteNombre: Cliente.nombre,
    })
    .from(Matricula)
    .innerJoin(Cliente, eq(Matricula.clienteId, Cliente.id))
    .orderBy(desc(Matricula.id));

const todosLosClientes = await db.select().from(Cliente);

// 2. Configurar Columnas
const columnasMatriculas = [
    { key: 'numero', label: 'Matrícula', type: 'badge' },
    { key: 'clienteNombre', label: 'Cliente' },
    { key: 'id', label: 'Acciones', type: 'action', align: 'right' }
];

// 3. Configurar Campos Formulario
const camposMatriculas = [
    { name: 'numero', label: 'Matrícula', type: 'text', placeholder: '0000BBB' },
    { 
        name: 'clienteNombre', 
        label: 'Asignar a Cliente', 
        type: 'datalist', 
        datalist: todosLosClientes.map(c => c.nombre),
        placeholder: 'Escribe para buscar...'
    }
];
---

<DashboardLayout title="Control de Flota">
    <div class="space-y-12">
        <DynamicForm 
            title="Flota"
            subtitle="Registro de Vehículo"
            fields={camposMatriculas}
            actionName="upsertMatricula"
            buttonText="Vincular"
        />

        <DynamicTable 
            id="matriculas"
            columns={columnasMatriculas}
            data={matriculasConCliente}
            searchPlaceholder="Buscar por matrícula o cliente..."
        />
    </div>
    <DynamicModal />
</DashboardLayout>